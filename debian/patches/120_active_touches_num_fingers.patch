From 3a87e4530d065a114024a602fa76a4b94d905801 Mon Sep 17 00:00:00 2001
From: Chase Douglas <chase.douglas@canonical.com>
Date: Tue, 29 Mar 2011 10:28:52 -0400
Subject: [PATCH 2/3] Use the number of active touches instead of BTN_*TAP

The kernel doesn't know about inactive areas of the touchpad, so it
doesn't filter out inactive touches when counting the number of fingers
for events like BTN_DOUBLETAP.

When touch data is provided, use the current active touch count instead.

Signed-off-by: Chase Douglas <chase.douglas@canonical.com>
---
 src/eventcomm.c |    8 +++++++-
 src/eventcomm.h |    1 +
 2 files changed, 8 insertions(+), 1 deletions(-)

diff --git a/src/eventcomm.c b/src/eventcomm.c
index bb22f55..d3fc943 100644
--- a/src/eventcomm.c
+++ b/src/eventcomm.c
@@ -459,6 +459,7 @@ ProcessTouch(InputInfoPtr pInfo, SynapticsPrivate *priv)
                            XI_TouchEnd, 0, ecpriv->touch_mask);
         ecpriv->mt_slot_map[ecpriv->cur_slot] = -1;
         ecpriv->close_slot = FALSE;
+        ecpriv->active_touches--;
     }
     else
     {
@@ -470,9 +471,12 @@ ProcessTouch(InputInfoPtr pInfo, SynapticsPrivate *priv)
             int y = valuator_mask_get(ecpriv->touch_mask, y_axis);
 
             if (is_inside_active_area(priv, x, y))
+            {
                 xf86PostTouchEvent(pInfo->dev,
                                    ecpriv->mt_slot_map[ecpriv->cur_slot],
                                    XI_TouchBegin, 0, ecpriv->touch_mask);
+                ecpriv->active_touches++;
+            }
             else
                 ecpriv->mt_slot_map[ecpriv->cur_slot] = -1;
         }
@@ -531,7 +535,9 @@ EventProcessEvent(InputInfoPtr pInfo, struct CommData *comm,
     case EV_SYN:
         switch (ev->code) {
         case SYN_REPORT:
-            if (comm->oneFinger)
+            if (priv->has_touch)
+                hw->numFingers = ecpriv->active_touches;
+            else if (comm->oneFinger)
                 hw->numFingers = 1;
             else if (comm->twoFingers)
                 hw->numFingers = 2;
diff --git a/src/eventcomm.h b/src/eventcomm.h
index c6ef87c..d9c9ebb 100644
--- a/src/eventcomm.h
+++ b/src/eventcomm.h
@@ -58,6 +58,7 @@ typedef struct {
     int num_touches;
     struct mtdev *mtdev;
     struct grail *grail;
+    int active_touches;
 } EventcommPrivate;
 
 extern Bool EventProcessEvent(InputInfoPtr pInfo, struct CommData *comm,
-- 
1.7.4.1

